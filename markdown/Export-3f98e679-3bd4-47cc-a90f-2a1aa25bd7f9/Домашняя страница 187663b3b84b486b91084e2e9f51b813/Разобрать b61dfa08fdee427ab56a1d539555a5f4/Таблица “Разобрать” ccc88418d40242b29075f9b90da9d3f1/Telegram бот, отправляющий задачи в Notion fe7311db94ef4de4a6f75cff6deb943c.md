# Telegram бот, отправляющий задачи в Notion

Date [HIDE]: November 9, 2022 3:50 PM
Без разбора: 107 дней
Добавлено: 09.11.2022
Разобрано: No
Ссылка: https://amorev.ru/telegram-notion-integration/
Темы: ../%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%20%E2%80%9C%D0%A2%D0%B5%D0%BC%D1%8B%E2%80%9D%205261d8ac365a4baa890082f78175e751/Python%2056ea1d4987c94572bc191d10854812ef.md

Я уже писал ранее, что Notion выпустили свое API и я написал интеграцию с Telegram (подробнее [тут](https://amorev.ru/notion-beta-api-release/)) и я был несказанно рад этой новости! Писал я про это уже 4 месяца назад и я, сразу-же, сделал себе на коленке небольшого бота, который ставит мне задачи и через которого другие люди также могут ставить мне задачи.

У данного поста есть видео версия. Посмотреть можно прямо здесь или перейдя [по ссылке](https://youtu.be/XzhQzuWBAcg).

Я очень люблю Notion - я пользуюсь им уже почти год и все больше и больше внедряю его в свои процессы. Вот уже несколько месяцев все свои личные задачи я веду через него. Я стараюсь прийти к тому, что в Notion лежали все задачи, которыми мне нужно заниматься.

Но я для себя заметил, что добавление задач отнимает много времени - зайти в notion, открыть нужную доску, дождаться пока загрузится страница, добавить задачу. Разумеется, мой ленивый разум быстро нашел в этом причину чтобы не вести задачи. Но потом появилось API и я быстро накидал себе бота, который добавляет задачу на каждое сообщение в Telegram.

В рамках данного поста я поделился своим способом достижения этого результата на Typescript.

## Первая версия бота

Первое, что я сделал с его появлением - простого Telegram бота, через которого мне можно ставить задачи. Работает он простым образом:

1. Я пишу Telegram боту любой текст
2. В notion, в моем списке задач, создается карточка, в названии которого лежит текст сообщения
3. В ответ бот присылает мне оповещение о том, что задача создана и передает ссылку на карточку
4. Также боту может написать человек, которому я дал право ставить мне задачи. Это тоже приводит к созданию карточки задачи с пометкой автора задачи.

Дальше этого бота расширять можно сколь угодно много. Но сегодня мы с вами сделаем простую базовую версию.

## Подключение к Notion API

Для начала нужно получить token для работы. Сделать это можно по инструкции [здесь](https://developers.notion.com/docs/getting-started). Также опишу этот процесс здесь:

- Придумываем название интеграции
- Попадаем на страницу с вашим токеном

Дальше этот токен можно скопировать кнопкой Copy и использовать его в своем приложении.

## Создаем базу данных задач

Дальше нужно в любом удобном вам месте в Notion создать базу данных с Kan Ban представлением, добавить поля статуса и источника задачи. Или можете просто скопировать мой [тестовый список задач](https://www.notion.so/95f371ba0f9a4756bd7d580c484e3be4) и использовать его как шаблон.

Кнопка для дублирования в качестве шаблона

Отлично! Теперь у нас есть база задач, которую вы можете наполнять руками через Notion! Но мы здесь с вами не для этого. Теперь нам необходимо настроить интеграцию между notion и telegram ботом.

## Заготовка Telegram бота на typescript

Я подготовил проект, в котором реализовал базовую логику интеграции. Вы можете посмотреть его код [на](https://github.com/gmoreva/2-notion-tasks) [GitHub](https://github.com/gmoreva/2-notion-tasks/tree/0.0.1) (версия 0.0.1). Внутри есть readme.md, в котором описано как запускать бота, а я пройдусь по основным моментам работы интеграции.

### Базовая инициализация бота

```
const bot = new Telegraf(process.env!.TELEGRAM_BOT_TOKEN)
const telegramownerid = Number(process.env!.TELEGRAM_OWNER_ID)
const allowTelegramIds = process.env!.TELEGRAM_ALLOW_IDS.split(',').map(e => Number(e))
console.log({
    allowTelegramIds,
    telegramownerid
})
bot.start((ctx) => ctx.reply('Welcome'))
bot.on('message', async function (ctx: Context) {
```

В рамках данной инициализации мы используем следующие переменные:

- **TELEGRAM_BOT_TOKEN** токен, который мы получили через [@BotFather](https://t.me/botfather)
- **TELEGRAM_OWNER_ID** Мой личный Telegram Id, чтобы можно было идентифицировать меня, как администратора
- **TELEGRAM_ALLOW_IDS** строка, где, через запятую, перечислены Telegram ID людей, которым доступна постановка мне задач.

### Обработка входящего сообщения

Сообщение, которое мы отправляем боту, приходит на наш сервер в виде объекта Context, у которого есть поле message с полями:

- id сообщения
- текст сообщения
- информация об отправителе: имя, username и, самое главное, id

Разумеется есть много чего еще, но нам достаточно этого набора полей.

### Подготовка объекта на отправку в notion

Для отправки задачи в Notion мы создаем объект

|  | { |
| --- | --- |
|  | parent: { |
|  | database_id: taskDB |
|  | }, |
|  | properties: { |
|  | Name: { |
|  | type: "title", |
|  | title: [ |
|  | { |
|  | type: "text", |
|  | text: { |
|  | content: title |
|  | } |
|  | } |
|  | ] |
|  | }, |
|  | TGAuthor: { |
|  | type: "rich_text", |
|  | rich_text: [ |
|  | { |
|  | type: "text", |
|  | text: { |
|  | content: tgAuthor |
|  | } |
|  | } |
|  | ] |
|  | }, |
|  | Status: { |
|  | type: "select", |
|  | select: { |
|  | name: 'Backlog' |
|  | } |
|  | }, |
|  | Source: { |
|  | type: "select", |
|  | select: { |
|  | name: 'Telegram' |
|  | } |
|  | } |
|  | } |
|  | } |

На 3 строчке есть переменная `taskDb`, туда нам необходимо разместить ID вашей базы данных. Получить её можно из ссылки. Где её взять можете увидеть из скрина ниже.

Расположение ID базы данных

На 23 строчке в примере в переменную `tgAuthor`, в моем примере, подставляется username пользователя, чтобы потом можно было сообразить. Также можно увидеть другие поля в этом объекте:

- Name - название задачи,
- TGAuthor - автор задачи,
- Status - статус, в который мы отправляем задачу. В нашем примере это Backlog,
- Source - источник задачи. Проставляем Telegram.

После подготовки объекта мы отправляем POST запрос на метод создания страницы (документация [тут](https://developers.notion.com/reference/post-page)). Поскольку мой пример написан на Typescript, я использую NPM пакет [@notionhq/client](https://www.npmjs.com/package/@notionhq/client).

После отправки запроса, в Notion, создается карточка задачи, с которой уже можно работать как вам угодно.

### Обработка сообщений от других пользователей

В первой же версии я захотел сделать так, чтобы мне могли ставить задачи другие люди. Для решения этой задачи я добавил в env переменные значение **TELEGRAM_ALLOW_IDS**, где, через запятую, перечислил идентификаторы Telegram пользователей, которые могут ставить мне задачи.

Когда они ставят мне задачу бот также создает задачу в Notion и оповещает меня о том, что кто то осчастливил меня новой задачей.

## Вместо заключения

Таким образом я получил себе верного помощника, который позволяет мне забывать меньше задач, а другим быть чуть более уверенным, что я не забуду про то, о чем меня попросили.

Бот активно дорабатывается и расширяется. Так что, в ближайшее время, будет еще контент про то, как можно автоматизировать свои рутинные действия.

Если вам интересны темы интеграции с Notion, то предлагаю прочитать пост про [интеграцию Notion с Google Calendar](https://amorev.ru/notion-event-to-calendar/)

До связи!